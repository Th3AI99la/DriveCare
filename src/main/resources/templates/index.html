<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DriveCare - Dashboard</title>

  <!-- Bootstrap CSS e Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/styles/custom.css">

  <!-- Scripts do Chart.js e custom -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/scripts/custom.js" defer></script>
</head>
<body class="dark-mode">

  <div class="container-fluid">
    <div class="row">

      <!-- NAV LATERAL ESQUERDA -->
      <nav class="col-md-2 d-none d-md-block sidebar vh-100 bg-primary-dark">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <!-- Painel -->
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" th:href="@{/}">
                <i class="bi bi-speedometer2 me-2"></i>
                Painel
              </a>
            </li>

            <!-- Veículos -->
            <li class="nav-item">
              <a class="nav-link" th:href="@{/vehicles}">
                <i class="bi bi-car-front me-2"></i>
                Veículos
              </a>
            </li>

            <!-- Manutenções -->
            <li class="nav-item">
              <a class="nav-link" th:href="@{/maintenances}">
                <i class="bi bi-tools me-2"></i>
                Manutenções
              </a>
            </li>

            <!-- Perfil -->
            <li class="nav-item">
              <a class="nav-link" th:href="@{/profile}">
                <i class="bi bi-person-circle me-2"></i>
                Perfil
              </a>
            </li>

            <!-- Espaço harmônico -->
            <br /><br />

            <!-- Sair -->
            <li class="nav-item">
              <a class="nav-link text-danger" th:href="@{/logout}">
                <i class="bi bi-box-arrow-right me-2"></i>
                Sair
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- CONTEÚDO PRINCIPAL -->
      <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 bg-dark text-light">

        <!-- HEADER com ícone do usuário -->
        <header class="d-flex justify-content-end py-3 border-bottom border-secondary">
          <a href="#" th:href="@{/profile}" class="animate-hover">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077063.png" alt="Perfil" width="40" height="40" class="rounded-circle">
          </a>
        </header>

        <!-- CARDS RESUMO -->
        <div class="row my-4 g-3">
          <!-- Total de Veículos -->
          <div class="col-md-2">
            <div class="card bg-primary text-white text-center animate-card">
              <div class="card-body">
                <i class="bi bi-car-front-fill fs-1 mb-2"></i>
                <h6>Total de Veículos</h6>
                <h3 th:text="${totalVeiculos}">0</h3>
              </div>
            </div>
          </div>

          <!-- Manutenções em Dia -->
          <div class="col-md-2">
            <div class="card bg-success text-white text-center animate-card">
              <div class="card-body">
                <i class="bi bi-check-circle-fill fs-1 mb-2"></i>
                <h6>Em Dia</h6>
                <h3 th:text="${veiculosOk}">0</h3>
              </div>
            </div>
          </div>

          <!-- Manutenções Pendentes -->
          <div class="col-md-2">
            <div class="card bg-warning text-dark text-center animate-card">
              <div class="card-body">
                <i class="bi bi-exclamation-triangle-fill fs-1 mb-2"></i>
                <h6>Pendentes</h6>
                <h3 th:text="${veiculosPendentes}">0</h3>
              </div>
            </div>
          </div>

          <!-- Alertas Críticos -->
          <div class="col-md-2">
            <div class="card bg-danger text-white text-center animate-card">
              <div class="card-body">
                <i class="bi bi-exclamation-octagon-fill fs-1 mb-2"></i>
                <h6>Alertas Críticos</h6>
                <h3 th:text="${veiculosAtrasados}">0</h3>
              </div>
            </div>
          </div>

          <!-- Gastos Totais -->
          <div class="col-md-4">
            <div class="card bg-secondary text-white text-center animate-card">
              <div class="card-body">
                <i class="bi bi-currency-dollar fs-1 mb-2"></i>
                <h6>Gastos Totais (mês)</h6>
                <h3 th:text="'R$ ' + ${despesasMensais}">R$ 0,00</h3>
              </div>
            </div>
          </div>
        </div>

        <!-- GRÁFICOS -->
        <div class="row my-4">
          <!-- Gráfico de Linhas: Status dos veículos -->
          <div class="col-md-8">
            <div class="card bg-dark-light">
              <div class="card-header bg-dark border-secondary">Status dos Veículos</div>
              <div class="card-body">
                <canvas id="lineChart"></canvas>
                <div th:unless="${not #lists.isEmpty(dadosStatusVeiculos)}" class="text-center text-muted">
                  Nenhum dado disponível
                </div>
              </div>
            </div>
          </div>

          <!-- Gráfico de Donut: Tipos de Manutenção -->
          <div class="col-md-4">
            <div class="card bg-dark-light">
              <div class="card-header bg-dark border-secondary">Tipos de Manutenção</div>
              <div class="card-body">
                <canvas id="donutChart"></canvas>
                <div th:unless="${not #lists.isEmpty(tiposManutencao)}" class="text-center text-muted">
                  Nenhum dado disponível
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- MANUTENÇÕES RECENTES -->
        <div class="my-4">
          <h4>Manutenções Recentes</h4>
          <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
              <thead>
                <tr>
                  <th>Veículo</th>
                  <th>Tipo</th>
                  <th>Data</th>
                  <th>Próxima</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="manutencao : ${manutencoesRecentes}">
                  <td th:text="${manutencao.veiculo.modelo}">Modelo</td>
                  <td th:text="${manutencao.tipo}">Tipo</td>
                  <td th:text="${manutencao.dataFormatada}">-</td>
                  <td th:text="${manutencao.proximaDataFormatada}">-</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- PRÓXIMAS MANUTENÇÕES - TABELA DINÂMICA -->
        <div class="my-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Próximas Manutenções</h4>
            <span class="text-muted" th:text="'Mostrando ' + ${contagemAtual} + ' de ' + ${totalContagem} + ' veículos'">Mostrando 0 de 0 veículos</span>
          </div>
          
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>Veículo</th>
                  <th>Placa</th>
                  <th>Próxima Manutenção</th>
                  <th>Status</th>
                  <th class="text-end">Dias</th>
                </tr>
              </thead>
              <tbody>
                <tr class="animate-row" th:each="manutencao : ${proximasManutencoes}">
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi me-2" 
                        th:classappend="${manutencao.tipo == 'Troca de óleo'} ? 'bi-droplet-fill text-primary' : 
                                        (${manutencao.tipo == 'Revisão'} ? 'bi-tools text-warning' : 'bi-exclamation-triangle-fill text-danger')">
                      </i>
                      <div>
                        <div th:text="${manutencao.veiculo.modelo}">-</div>
                        <small class="text-muted" th:text="${manutencao.tipo}">-</small>
                      </div>
                    </div>
                  </td>
                  
                  <td th:text="${manutencao.veiculo.placa}">-</td>
                  
                  <td th:text="${#dates.format(manutencao.proximaData, 'dd/MM/yyyy')}">-</td>
                  
                  <td>
                    <div class="progress" style="height: 6px; width: 100px;">
                      <div th:classappend="${manutencao.status == 'EM_DIA'} ? 'bg-success' : 
                                         ${manutencao.status == 'PROXIMO'} ? 'bg-warning' : 
                                         'bg-danger'"
                           th:styleappend="${manutencao.status == 'EM_DIA'} ? 'width: 30%' : 
                                         ${manutencao.status == 'PROXIMO'} ? 'width: 70%' : 
                                         'width: 100%'"
                           class="progress-bar"></div>
                    </div>
                  </td>
                  
                  <td class="text-end">
                    <span th:if="${manutencao.dias >= 0}" 
                          th:classappend="${manutencao.dias <= 2} ? 'bg-warning text-dark' : 'bg-info'"
                          th:text="${manutencao.dias == 0} ? 'Hoje' : 
                                  ${manutencao.dias == 1} ? 'Em 1 dia' : 
                                  'Em ' + ${manutencao.dias} + ' dias'"
                          class="badge">-</span>
                    <span th:if="${manutencao.dias < 0}" 
                          class="badge bg-danger"
                          th:text="${'Atrasada há ' + (manutencao.dias * -1) + ' dias'}">-</span>
                  </td>
                </tr>
                
                <tr th:if="${#lists.isEmpty(proximasManutencoes)}" class="animate-row">
                  <td colspan="5" class="text-center text-muted">Nenhuma manutenção agendada</td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Paginação dinâmica -->
          <nav aria-label="Navegação de páginas" th:if="${totalPaginas > 1}">
            <ul class="pagination justify-content-end mt-3">
              <li th:classappend="${paginaAtual == 1} ? 'disabled'" class="page-item">
                <a class="page-link" th:href="@{/dashboard(pagina=${paginaAtual-1})}" tabindex="-1">Anterior</a>
              </li>
              
              <li th:each="pagina : ${#numbers.sequence(1, totalPaginas)}"
                  th:classappend="${pagina == paginaAtual} ? 'active'"
                  class="page-item">
                <a class="page-link" th:href="@{/dashboard(pagina=${pagina})}" th:text="${pagina}">1</a>
              </li>
              
              <li th:classappend="${paginaAtual == totalPaginas} ? 'disabled'" class="page-item">
                <a class="page-link" th:href="@{/dashboard(pagina=${paginaAtual+1})}">Próxima</a>
              </li>
            </ul>
          </nav>
        </div>

        <!-- VEÍCULOS CADASTRADOS -->
        <div class="my-4">
          <h4>Veículos Cadastrados</h4>
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>Veículo</th>
                  <th>Placa</th>
                  <th>Próxima Manutenção</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="veiculo : ${veiculos}">
                  <td th:text="${veiculo.modelo}">Fusca</td>
                  <td th:text="${veiculo.placa}">ABC-1234</td>
                  <td th:text="${#dates.format(veiculo.proximaManutencao, 'dd/MM/yyyy')}">00/00/0000</td>
                  <td>
                    <span class="badge bg-success" th:if="${veiculo.status == 'OK'}">Em Dia</span>
                    <span class="badge bg-warning text-dark" th:if="${veiculo.status == 'PENDING'}">Pendente</span>
                    <span class="badge bg-danger" th:if="${veiculo.status == 'LATE'}">Atrasada</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- GRÁFICO DE BARRAS: SAÚDE DOS VEÍCULOS -->
        <div class="my-4">
          <div class="card bg-dark-light">
            <div class="card-header bg-dark border-secondary">Saúde dos Veículos</div>
            <div class="card-body">
              <canvas id="barChart"></canvas>
              <div th:unless="${not #lists.isEmpty(dadosSaudeVeiculos)}" class="text-center text-muted">
                Nenhum dado disponível
              </div>
            </div>
          </div>
        </div>

        <!-- RODAPÉ -->
        <footer class="text-center py-4">
          <hr class="border-secondary">
          <p class="text-muted">DriveCare © 2025</p>
        </footer>

      </main>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script para inicializar os gráficos -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Gráfico de Linha - Status dos Veículos
      const lineCtx = document.getElementById('lineChart');
      const lineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'],
          datasets: [{
            label: 'Veículos em Dia',
            data: [],
            borderColor: '#4CAF50',
            backgroundColor: 'rgba(76, 175, 80, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: getChartOptions('Status dos Veículos')
      });

      // Gráfico de Donut - Tipos de Manutenção
      const donutCtx = document.getElementById('donutChart');
      const donutChart = new Chart(donutCtx, {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{
            data: [],
            backgroundColor: ['#4CAF50', '#FF5722', '#2196F3', '#FFC107', '#9C27B0']
          }]
        },
        options: {
          ...getChartOptions('Tipos de Manutenção'),
          cutout: '70%'
        }
      });

      // Gráfico de Barras - Saúde dos Veículos
      const barCtx = document.getElementById('barChart');
      const barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Saúde (%)',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
          }]
        },
        options: getChartOptions('Saúde dos Veículos')
      });

      // Função para atualizar os gráficos com dados do backend
    function updateCharts(data) {
        // Verificar se os dados existem antes de atualizar os gráficos
        if (data.dadosStatusVeiculos?.valores) {
            lineChart.data.datasets[0].data = data.dadosStatusVeiculos.valores;
            lineChart.update();
        }
        if (data.tiposManutencao?.rotulos && data.tiposManutencao?.valores) {
            donutChart.data.labels = data.tiposManutencao.rotulos;
            donutChart.data.datasets[0].data = data.tiposManutencao.valores;
            donutChart.update();
        }
        if (data.dadosSaudeVeiculos?.rotulos && data.dadosSaudeVeiculos?.valores) {
            barChart.data.labels = data.dadosSaudeVeiculos.rotulos;
            barChart.data.datasets[0].data = data.dadosSaudeVeiculos.valores;
            barChart.update();
        }
    }

      // Função para opções comuns dos gráficos
      function getChartOptions(titulo) {
        return {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#e0e0e0'
              }
            },
            title: {
              display: true,
              color: '#e0e0e0',
              text: titulo
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#e0e0e0'
              }
            },
            x: {
              grid: {
                color: 'rgba(255, 255, 255, 0.1)'
              },
              ticks: {
                color: '#e0e0e0'
              }
            }
          }
        };
      }
    });
  </script>
</body>
</html>